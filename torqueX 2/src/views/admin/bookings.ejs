<%- include('../partials/header') %>

<div class="flex min-h-screen">
  <!-- Sidebar -->
  <div class="w-64 bg-white dark:bg-gray-800 text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-700 shadow-lg">
    <div class="p-4 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white">TorqueX Admin</h2>
    </div>
    <nav class="p-2">
      <ul class="space-y-1">
        <li>
          <a href="/admin/dashboard" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            Dashboard
          </a>
        </li>
        <li>
          <a href="/admin/vehicles" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Vehicles
          </a>
        </li>
        <li>
          <a href="/admin/bookings" class="flex items-center px-4 py-2 text-gray-900 dark:text-white bg-gray-200 dark:bg-gray-700 rounded-md font-medium shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            Bookings
          </a>
        </li>
        <li>
          <a href="/admin/broadcasts" class="flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
            </svg>
            Broadcasts
          </a>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="flex-1 bg-gray-50 dark:bg-gray-900 overflow-y-auto">
    <div class="p-6">
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Manage Bookings</h1>

      <!-- Filter Controls -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <div class="flex flex-wrap gap-4">
          <div class="flex-1 min-w-[200px]">
            <label for="status-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Filter by Status</label>
            <select id="status-filter" class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
              <option value="">All Statuses</option>
              <option value="PENDING">Pending</option>
              <option value="CONFIRMED">Confirmed</option>
              <option value="CANCELLED">Cancelled</option>
              <option value="COMPLETED">Completed</option>
            </select>
          </div>
          <div class="flex-1 min-w-[200px]">
            <label for="date-filter" class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Filter by Date</label>
            <input type="date" id="date-filter" class="block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
          </div>
          <div class="flex items-end">
            <button id="filter-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Apply Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Bookings Table -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-200 dark:border-gray-700">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
            <thead class="bg-gray-50 dark:bg-gray-700">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Booking ID</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">User</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Vehicle</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Start Date</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">End Date</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Price</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Status</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-700 divide-y divide-gray-200 dark:divide-gray-600">
              <% if (bookings && bookings.length > 0) { %>
                <% bookings.forEach(booking => { %>
                  <tr data-status="<%= booking.status %>">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">
                      <%= booking.id.substring(0, 8) %>...
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                      <%= booking.user?.name || 'Unknown User' %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                      <%= booking.vehicle?.name || 'Unknown Vehicle' %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                      <%= new Date(booking.startDate).toLocaleDateString() %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                      <%= new Date(booking.endDate).toLocaleDateString() %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300">
                      $<%= booking.totalPrice.toFixed(2) %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <% if (booking.status === 'PENDING') { %>
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200">
                          Pending
                        </span>
                      <% } else if (booking.status === 'CONFIRMED') { %>
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200">
                          Confirmed
                        </span>
                      <% } else if (booking.status === 'CANCELLED') { %>
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200">
                          Cancelled
                        </span>
                      <% } else if (booking.status === 'COMPLETED') { %>
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200">
                          Completed
                        </span>
                      <% } %>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <select class="status-select rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-600 text-gray-900 dark:text-white text-sm px-2 py-1" data-booking-id="<%= booking.id %>">
                        <option value="PENDING" <%= booking.status === 'PENDING' ? 'selected' : '' %>>Pending</option>
                        <option value="CONFIRMED" <%= booking.status === 'CONFIRMED' ? 'selected' : '' %>>Confirm</option>
                        <option value="CANCELLED" <%= booking.status === 'CANCELLED' ? 'selected' : '' %>>Cancel</option>
                        <option value="COMPLETED" <%= booking.status === 'COMPLETED' ? 'selected' : '' %>>Complete</option>
                      </select>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400 text-center">
                    No bookings found
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Filter functionality
  document.getElementById('filter-button')?.addEventListener('click', function() {
    const statusFilter = document.getElementById('status-filter').value;
    const dateFilter = document.getElementById('date-filter').value;
    
    const rows = document.querySelectorAll('tbody tr[data-status]');
    
    rows.forEach(row => {
      let show = true;
      
      // Filter by status
      if (statusFilter && row.getAttribute('data-status') !== statusFilter) {
        show = false;
      }
      
      // Filter by date (if implemented)
      // This would need additional data attributes on the rows
      
      row.style.display = show ? '' : 'none';
    });
  });
  
  // Status update functionality
  document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async function() {
      const bookingId = this.getAttribute('data-booking-id');
      const newStatus = this.value;
      
      try {
        const response = await fetch(`/admin/bookings/${bookingId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-csrf-token': '<%= csrfToken %>'
          },
          body: JSON.stringify({ status: newStatus }),
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the row status visually
          const row = this.closest('tr');
          row.setAttribute('data-status', newStatus);
          
          // Update status badge
          const statusCell = row.cells[6];
          
          let badgeHTML = '';
          if (newStatus === 'PENDING') {
            badgeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-900/30 text-yellow-200">Pending</span>';
          } else if (newStatus === 'CONFIRMED') {
            badgeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-900/30 text-green-200">Confirmed</span>';
          } else if (newStatus === 'CANCELLED') {
            badgeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-900/30 text-red-200">Cancelled</span>';
          } else if (newStatus === 'COMPLETED') {
            badgeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-900/30 text-blue-200">Completed</span>';
          }
          
          statusCell.innerHTML = badgeHTML;
          
          // Show success notification
          alert(`Booking status updated to ${newStatus}`);
        } else {
          alert(`Error: ${data.message || 'Could not update status'}`);
        }
      } catch (error) {
        console.error('Error updating booking status:', error);
        alert('Failed to update booking status. Please try again.');
      }
    });
  });
</script>

<%- include('../partials/footer') %>